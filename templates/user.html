{% extends 'base.html' %}

<!-- é¡µé¢æ ‡é¢˜å— -->
{% block title %}{{ user.username }} çš„ä¸»é¡µ - è§†é¢‘åˆ†äº«å¹³å°{% endblock %}

{% block content %}
<!-- ç”¨æˆ·ä¸»é¡µï¼Œæ˜¾ç¤ºç”¨æˆ·å -->
<h2 class="mb-4">{{ user.username }} çš„ä¸»é¡µ</h2>
{% if videos %}
    <!-- æœ‰è§†é¢‘æ—¶ï¼Œæ˜¾ç¤ºè§†é¢‘åˆ—è¡¨ -->
    <ul class="list-group">
        <!-- å¾ªç¯æ¯ä¸ªè§†é¢‘ -->
        {% for video in videos %}
        <!-- æ¯ä¸ªè§†é¢‘åˆ—è¡¨é¡¹ -->
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <!-- è§†é¢‘é“¾æ¥ï¼Œç‚¹å‡»æ’­æ”¾ -->
                ğŸ¬ 
                <a href="{{ url_for('play_video', video_id=video.id) }}">
                    <!-- æ˜¾ç¤ºè§†é¢‘æ–‡ä»¶å -->
                    {{ video.filename.rsplit('/',1)[-1] }}
                </a>
            </div>
            <!-- å½“ç”¨æˆ·å·²ç™»å½•ä¸”ä¸ºè¯¥é¡µé¢ç”¨æˆ·æ—¶ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’® -->
            {% if current_user.is_authenticated and current_user == user %}
            <!-- åˆ é™¤è§†é¢‘æŒ‰é’® -->
            <button class="btn btn-sm btn-danger delete-video" 
                    data-video-id="{{ video.id }}">åˆ é™¤</button>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
{% else %}
    <!-- å½“æ²¡æœ‰è§†é¢‘æ—¶ï¼Œæ˜¾ç¤ºæç¤ºè¯­ -->
    <p class="text-muted">æš‚æ— è§†é¢‘</p>
{% endif %}
<!-- ---------------------------------------------------------------------------- -->
<!-- JavaScriptéƒ¨åˆ†ï¼Œç›´æ¥åµŒå…¥åœ¨é¡µé¢åº•éƒ¨ï¼Œä»¥ç¡®ä¿åœ¨DOMåŠ è½½åæ‰§è¡Œ -->
<script>
// ç¡®ä¿DOMåŠ è½½åè¿è¡Œè„šæœ¬
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMå®Œå…¨åŠ è½½ï¼Œè„šæœ¬æ‰§è¡Œä¸­');

    // æŸ¥æ‰¾æ‰€æœ‰åˆ é™¤æŒ‰é’®
    const deleteButtons = document.querySelectorAll('.delete-video');
    console.log(`æ‰¾åˆ° ${deleteButtons.length} ä¸ªåˆ é™¤æŒ‰é’®`);

    deleteButtons.forEach(button => {
        // ä¸ºæ¯ä¸ªæŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
        button.addEventListener('click', function() {
            console.log('åˆ é™¤æŒ‰é’®è¢«ç‚¹å‡»');
            // æç¤ºç”¨æˆ·ç¡®è®¤åˆ é™¤æ“ä½œ
            if (!confirm('ç¡®è®¤åˆ é™¤è¯¥è§†é¢‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                console.log('ç”¨æˆ·å–æ¶ˆäº†åˆ é™¤æ“ä½œã€‚');
                return;
            }

            // è·å–è§†é¢‘ID
            const videoId = this.dataset.videoId;
            console.log(`å°è¯•åˆ é™¤è§†é¢‘ï¼ŒID: ${videoId}`);

            // å‘é€AJAX POSTè¯·æ±‚ä»¥åˆ é™¤è§†é¢‘
            fetch(`/delete_video/${videoId}`, {
                method: 'POST', // ä½¿ç”¨HTTP POSTæ–¹æ³•
                headers: {
                    'Content-Type': 'application/json'  // è®¾å®šè¯·æ±‚å¤´ä¸ºJSONç±»å‹
                },
                credentials: 'include'  // åŒ…å«å‡­æ®å’Œä¼šè¯ä¿¡æ¯
            }).then(response => {
                console.log(`æœåŠ¡å™¨å“åº”çŠ¶æ€: ${response.status}`);
                if (response.ok) {  // æ£€æŸ¥å“åº”çŠ¶æ€æ˜¯å¦ä¸ºæˆåŠŸ
                    console.log('è§†é¢‘å·²æˆåŠŸåˆ é™¤');
                    this.closest('li').remove();  // ä»DOMä¸­ç§»é™¤æ­¤è§†é¢‘åˆ—è¡¨é¡¹
                    alert('è§†é¢‘å·²åˆ é™¤');
                } else {
                    console.error('æœåŠ¡å™¨è¿”å›é”™è¯¯');
                    response.text().then(text => {
                        // è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶æç¤ºç”¨æˆ·
                        console.error('åˆ é™¤å¤±è´¥åŸå› :', text);
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼š' + text);
                    });
                }
            }).catch(error => {
                // æ•è·å¹¶å¤„ç†è¯·æ±‚ä¸­çš„ä»»ä½•é”™è¯¯
                console.error('åˆ é™¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                alert('åˆ é™¤è¿‡ç¨‹å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            });
        });
    });
});
</script>

{% endblock %}
